{% extends 'myapp/base.html' %}
{% load static %}
{% load youtube_extras %}
{% block title %}Ver {{ episodio.titulo }} | {{ contenido.titulo }}{% endblock %}
{% block content %}
<!-- Breadcrumb Begin -->
<div class="breadcrumb-option">
    <div class="container">
        <div class="row">
            <div class="col-lg-12">
                <div class="breadcrumb__links">
                    <a href="{% url 'index' %}"><i class="fa fa-home"></i> Inicio</a>
                    <a href="{% url 'categories' %}">Categorías</a>
                    <a href="{% url 'anime_details' contenido.id %}">{{ contenido.titulo }}</a>
                    <span>{{ episodio.titulo }}</span>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Breadcrumb End -->

<!-- Anime Section Begin -->
<section class="anime-details spad">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-10 col-xl-9">
                <div class="anime__video__player mb-4 rounded shadow overflow-hidden plyr__video-outer">
                    {% if 'youtube.com' in episodio.video_url or 'youtu.be' in episodio.video_url %}
                        <div class="ratio ratio-16x9">
                            <iframe id="player" width="100%" height="500" src="https://www.youtube.com/embed/{{ episodio.video_url|youtube_id }}" frameborder="0" allowfullscreen allow="fullscreen"></iframe>
                        </div>
                    {% else %}
                        <video id="player" class="w-100 rounded" playsinline controls poster="{% if contenido.imagen_portada %}{{ contenido.imagen_portada.url }}{% else %}{% static 'myapp/img/default-cover.jpg' %}{% endif %}" style="background: #181828;" webkit-playsinline>
                            <source src="{{ episodio.video_url }}" type="video/mp4" />
                            Tu navegador no soporta la reproducción de video.
                        </video>
                    {% endif %}
                </div>
                <div class="row g-4">
                    <div class="col-md-8">
                        <div class="anime__episode__desc bg-dark p-4 rounded mb-3">
                            <h4 class="text-purple mb-2">{{ episodio.titulo }}</h4>
                            <p class="mb-2"><strong>Descripción:</strong> {{ episodio.descripcion|default:'Sin descripción.' }}</p>
                            <div class="d-flex flex-wrap gap-3 mb-2">
                                <span class="badge bg-purple">Temporada: {{ episodio.temporada }}</span>
                                <span class="badge bg-purple">N° Episodio: {{ episodio.numero_episodio }}</span>
                                <span class="badge bg-purple">Duración: {{ episodio.duracion }} min</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="anime__details__episodes bg-dark p-3 rounded mb-4">
                            <div class="section-title mb-2">
                                <h5 class="text-purple">Episodios</h5>
                            </div>
                            <div class="list-group">
                                {% for ep in contenido.episodio_set.all %}
                                    <a href="{% url 'anime_watching' ep.id %}" class="list-group-item list-group-item-action {% if ep.id == episodio.id %}active{% endif %} {% if ep.id in episodios_vistos %}visto{% endif %}">
                                        Ep {{ ep.numero_episodio }} - {{ ep.titulo }}
                                        {% if ep.id in episodios_vistos %}<span class="badge bg-success ms-2">Visto</span>{% endif %}
                                    </a>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
<!-- Anime Section End -->

<style>
.bg-purple {
    background: var(--main-purple, #8c52ff) !important;
    color: #fff !important;
    font-weight: 600;
    font-size: 1em;
}
.anime__video__player video, .anime__video__player iframe {
    border-radius: 12px;
    box-shadow: 0 4px 24px #0005;
}
.anime__episode__desc {
    font-size: 1.08rem;
}
.plyr__video-outer, .plyr__video-outer .plyr, .plyr__video-outer video, .plyr__video-outer iframe {
    width: 100% !important;
    height: 100% !important;
    max-width: 100vw !important;
    max-height: 100vh !important;
    min-height: 320px;
}
.plyr--fullscreen-enabled .plyr__video-outer,
.plyr--fullscreen-enabled .plyr__video-outer .plyr,
.plyr--fullscreen-enabled .plyr__video-outer video,
.plyr--fullscreen-enabled .plyr__video-outer iframe {
    width: 100vw !important;
    height: 100vh !important;
    max-width: 100vw !important;
    max-height: 100vh !important;
    min-height: 100vh !important;
    background: #000 !important;
}
/* Mejoras responsividad y fullscreen */
@media (max-width: 991px) {
    .anime__video__player { margin-bottom: 2rem; }
    .anime__episode__desc, .anime__details__episodes { margin-bottom: 1.5rem; }
    .anime__episode__desc, .anime__details__episodes { font-size: 1em; }
    .anime__details__episodes { padding: 1rem 0.5rem; }
}
@media (max-width: 767px) {
    .anime__video__player { margin-bottom: 1rem; }
    .anime__episode__desc, .anime__details__episodes { padding: 0.5rem; font-size: 0.98em; }
    .anime__details__episodes .list-group-item { font-size: 0.95em; }
}
/* Ocultar columnas en fullscreen */
.plyr--fullscreen-enabled .anime__episode__desc,
.plyr--fullscreen-enabled .anime__details__episodes {
    display: none !important;
    opacity: 0;
    transition: opacity 0.3s;
}
/* Microinteracción visual fullscreen */
.plyr--fullscreen-enabled .plyr__video-outer {
    animation: fadeInFull 0.4s;
}
@keyframes fadeInFull {
    from { opacity: 0; }
    to { opacity: 1; }
}
/* Mejor contraste para episodios activos/vistos */
.list-group-item.active, .list-group-item.active:focus, .list-group-item.active:hover {
    background: var(--main-purple, #8c52ff) !important;
    color: #fff !important;
    border-color: #8c52ff !important;
}
.list-group-item.visto:not(.active) {
    background: #23234a !important;
    color: #b7b7b7 !important;
    font-weight: 500;
}
.list-group-item.visto .badge.bg-success {
    background: #4caf50 !important;
    color: #fff;
}
</style>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        if (document.getElementById('player') && typeof Plyr !== 'undefined') {
            const player = new Plyr('#player', {
                controls: [
                    'play-large', 'play', 'progress', 'current-time', 'mute', 'volume', 'settings', 'pip', 'airplay', 'fullscreen'
                ],
                settings: ['quality', 'speed'],
                seekTime: 10,
                ratio: '16:9',
                i18n: {
                    play: 'Reproducir',
                    pause: 'Pausar',
                    mute: 'Silenciar',
                    unmute: 'Activar sonido',
                    fullscreen: 'Pantalla completa',
                    settings: 'Ajustes',
                    pip: 'Imagen en imagen',
                    airplay: 'AirPlay',
                    speed: 'Velocidad',
                    quality: 'Calidad',
                },
                tooltips: { controls: true, seek: true },
                hideControls: false,
                resetOnEnd: false,
                disableContextMenu: true,
            });
            // Microinteracción: fade al entrar/salir de fullscreen
            player.on('enterfullscreen', () => {
                document.querySelector('.plyr__video-outer').classList.add('plyr-fadein');
            });
            player.on('exitfullscreen', () => {
                document.querySelector('.plyr__video-outer').classList.remove('plyr-fadein');
            });
        }
    });
</script>
{% endblock %}